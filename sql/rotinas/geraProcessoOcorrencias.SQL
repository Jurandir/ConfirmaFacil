DECLARE @CONFIRMAFACILOCORRENCIA_ID as INT
DECLARE @CONFIRMAFACIL_ID           as INT
DECLARE @OCORRENCIA_DATA            as DATETIME
DECLARE @DATAOCO                    as DATETIME
DECLARE @OCORRENCIA_ID              as INT
DECLARE @OCORRENCIA_NOME            as NVARCHAR(60)

DECLARE @temp             as DATETIME

DECLARE Ocorrencia_Cursor CURSOR FOR 
SELECT TOP 50
      CO.ID               CONFIRMAFACILOCORRENCIA_ID,
      CF.ID               CONFIRMAFACIL_ID,
	   CO.OCORRENCIA_DATA  OCORRENCIA_DATA,
	   OUN.OCO_CODIGO      OCORRENCOA_ID,
	   OCO.NOME            OCORRENCIA_NOME,
      OUN.DATAOCO         DATAOCO 
FROM CARGASSQL.dbo.OUN
    JOIN CARGASSQL.dbo.OCO                       ON OCO.CODIGO  = OUN.OCO_CODIGO
    JOIN SIC.dbo.CONFIRMAFACIL CF                ON CF.CTRC     = OUN.CHAVE 
	 LEFT JOIN SIC.dbo.CONFIRMAFACILOCORRENCIA CO ON CO.CONFIRMAFACIL_ID = CF.ID AND CO.OCORRENCIA_ID = OUN.OCO_CODIGO AND CO.OCORRENCIA_DATA = OUN.DATAOCO
	                                             
WHERE 
    OUN.TABELA='CNH' AND 
	 OCO.NAOENVIAEDI = 0 AND CO.OCORRENCIA_DATA IS NULL 
ORDER BY
   OUN.DATA
;	

OPEN Ocorrencia_Cursor;  

FETCH NEXT FROM Ocorrencia_Cursor INTO 
	     @CONFIRMAFACILOCORRENCIA_ID , @CONFIRMAFACIL_ID , @OCORRENCIA_DATA , @OCORRENCIA_ID , @OCORRENCIA_NOME , @DATAOCO ;  

WHILE @@FETCH_STATUS = 0  
   BEGIN  
      
      BEGIN TRANSACTION;

      IF ( @CONFIRMAFACILOCORRENCIA_ID IS NULL )
         BEGIN
		    Print 'Insert.' ;
            INSERT INTO SIC.dbo.CONFIRMAFACILOCORRENCIA ( CONFIRMAFACIL_ID, OCORRENCIA_ID, OCORRENCIA_NOME, OCORRENCIA_DATA )
            VALUES ( @CONFIRMAFACIL_ID, @OCORRENCIA_ID, @OCORRENCIA_NOME, @DATAOCO );
         END  
      ELSE
         BEGIN
		    Print 'Update.' ;
            UPDATE SIC.dbo.CONFIRMAFACILOCORRENCIA
            SET OCORRENCIA_DATA = @DATAOCO
            WHERE ID = @CONFIRMAFACILOCORRENCIA_ID;
         END  
      ;

      Print @@ROWCOUNT; --- ajustar o UPDATE PARA AS OCORRENCIAS AJUSTAR A DATA DO EVENTO

      COMMIT TRANSACTION;

            SET @temp = (SELECT OCORRENCIA_DATA FROM SIC.dbo.CONFIRMAFACILOCORRENCIA WHERE ID = @CONFIRMAFACILOCORRENCIA_ID ) 
      
            Print @CONFIRMAFACILOCORRENCIA_ID ;
            Print @DATAOCO ;
            Print @OCORRENCIA_DATA ;
            Print @temp ;


      FETCH NEXT FROM Ocorrencia_Cursor INTO 
	     @CONFIRMAFACILOCORRENCIA_ID , @CONFIRMAFACIL_ID , @OCORRENCIA_DATA , @OCORRENCIA_ID , @OCORRENCIA_NOME , @DATAOCO ;  

   END;  

CLOSE Ocorrencia_Cursor;  
DEALLOCATE Ocorrencia_Cursor;  

GO 